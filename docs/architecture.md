# Архитектура системы мониторинга

Подробное описание архитектуры универсального стека мониторинга для Kubernetes.

## Обзор

Система мониторинга построена на принципах:
- **Мультипроектность** - один стек для всех проектов
- **Автоматическое обнаружение** - метрики и логи собираются автоматически
- **Изоляция** - каждый проект управляет своими ServiceMonitor
- **Масштабируемость** - легко добавлять новые проекты

## Компоненты

### Prometheus

**Назначение**: Сбор и хранение метрик

**Ключевые настройки**:
- `serviceMonitorSelectorNilUsesHelmValues: false` - собирать из всех namespace
- `serviceMonitorNamespaceSelector: {}` - без фильтрации по namespace
- Автоматическое обнаружение ServiceMonitor во всех namespace

**Как работает**:
1. Prometheus Operator следит за ServiceMonitor ресурсами
2. При создании ServiceMonitor автоматически добавляется target в Prometheus
3. Prometheus собирает метрики по расписанию (обычно каждые 30 секунд)

### Grafana

**Назначение**: Визуализация метрик и логов

**Источники данных**:
- Prometheus - для метрик
- Loki - для логов

**Provisioning**:
- Datasources настраиваются автоматически через Helm values
- Дашборды можно добавлять через ConfigMap или UI

### Loki

**Назначение**: Хранение и индексация логов

**Особенности**:
- Индексирует только метки (labels), не содержимое логов
- Эффективное хранение больших объемов логов
- Автоматическая retention политика

### Promtail

**Назначение**: Сбор логов из подов

**Как работает**:
1. Promtail использует Kubernetes Service Discovery для обнаружения подов
2. Собирает логи из всех подов во всех namespace
3. Добавляет метки из labels подов
4. Отправляет логи в Loki

## Архитектура сбора метрик

```
┌─────────────────────────────────────────────────────────┐
│  Namespace: monitoring                                    │
│                                                           │
│  ┌─────────────────────────────────────┐                │
│  │  Prometheus Operator                 │                │
│  │  (следит за ServiceMonitor)          │                │
│  └──────────────┬───────────────────────┘                │
│                 │                                         │
│  ┌──────────────▼───────────────┐                       │
│  │  Prometheus                   │                       │
│  │  (собирает метрики)            │                       │
│  └──────────────┬───────────────┘                       │
└─────────────────┼───────────────────────────────────────┘
                  │
                  │ Scrape targets
                  │
┌─────────────────┼───────────────────────────────────────┐
│ Namespace: project1                                      │
│                  │                                       │
│  ┌───────────────▼──────────────┐                      │
│  │  ServiceMonitor                │                      │
│  │  (описывает как собирать)      │                      │
│  └───────────────┬───────────────┘                      │
│                  │                                       │
│  ┌───────────────▼──────────────┐                      │
│  │  Service                       │                      │
│  │  (labels: monitoring=enabled)  │                      │
│  └───────────────┬───────────────┘                      │
│                  │                                       │
│  ┌───────────────▼──────────────┐                      │
│  │  Pods                         │                      │
│  │  (экспортируют /metrics)      │                      │
│  └──────────────────────────────┘                      │
└─────────────────────────────────────────────────────────┘
```

## Архитектура сбора логов

```
┌─────────────────────────────────────────────────────────┐
│  Namespace: monitoring                                    │
│                                                           │
│  ┌──────────────┐              ┌──────────────┐        │
│  │  Promtail     │──────────────>│  Loki        │        │
│  │  (собирает)   │   HTTP Push   │  (хранит)    │        │
│  └──────┬───────┘              └──────────────┘        │
│         │                                                 │
│         │ Kubernetes Service Discovery                   │
└─────────┼────────────────────────────────────────────────┘
          │
          │ Обнаруживает все поды
          │
┌─────────┼────────────────────────────────────────────────┐
│ Namespace: project1                                       │
│         │                                                  │
│  ┌──────▼──────┐                                          │
│  │  Pods        │                                          │
│  │  (логи)      │                                          │
│  └─────────────┘                                          │
└───────────────────────────────────────────────────────────┘
```

## Поток данных

### Метрики

1. **Приложение** экспортирует метрики на `/metrics`
2. **ServiceMonitor** описывает как собирать метрики
3. **Prometheus Operator** обнаруживает ServiceMonitor
4. **Prometheus** добавляет target и начинает сбор
5. **Grafana** запрашивает метрики из Prometheus через PromQL

### Логи

1. **Приложение** пишет логи в stdout/stderr
2. **Kubernetes** сохраняет логи в файлы на ноде
3. **Promtail** обнаруживает поды через Kubernetes API
4. **Promtail** читает логи и добавляет метки
5. **Promtail** отправляет логи в Loki через HTTP API
6. **Grafana** запрашивает логи из Loki через LogQL

## Мультипроектность

### Как это работает

1. **Единый Prometheus** в namespace `monitoring`
2. **ServiceMonitor в каждом проекте** - каждый проект создает свой ServiceMonitor
3. **Автоматическое обнаружение** - Prometheus находит все ServiceMonitor
4. **Фильтрация по labels** - используйте `namespace` или `project` для фильтрации

### Преимущества

- ✅ Один стек для всех проектов
- ✅ Легко добавлять новые проекты
- ✅ Централизованное управление
- ✅ Экономия ресурсов

### Изоляция

- Каждый проект управляет своими ServiceMonitor
- Метрики и логи фильтруются по `namespace` или `project` label
- Можно использовать RBAC для ограничения доступа

## Масштабирование

### Горизонтальное масштабирование

- Prometheus: можно увеличить количество реплик (но обычно 1 достаточно)
- Loki: поддерживает горизонтальное масштабирование через Loki Distributed
- Promtail: автоматически масштабируется с количеством нод

### Вертикальное масштабирование

Настройте ресурсы в values файлах:

```yaml
resources:
  limits:
    cpu: 2000m
    memory: 4Gi
  requests:
    cpu: 1000m
    memory: 2Gi
```

## Хранение данных

### Prometheus

- Хранит метрики в TSDB (Time Series Database)
- Retention настраивается (по умолчанию 15 дней)
- Использует PersistentVolume для хранения

### Loki

- Хранит логи в chunks
- Retention настраивается (по умолчанию 31 день)
- Использует PersistentVolume для хранения

## Безопасность

### Сетевая изоляция

- Все компоненты в namespace `monitoring`
- ServiceMonitor создаются в namespace проектов
- Можно использовать NetworkPolicy для дополнительной изоляции

### Аутентификация

- Grafana: базовая аутентификация (настраивается)
- Prometheus: обычно доступен только внутри кластера
- Loki: обычно доступен только внутри кластера

### RBAC

- Promtail требует RBAC для доступа к Kubernetes API
- Prometheus Operator требует RBAC для управления ServiceMonitor

## Мониторинг самого стека

Система мониторинга сама себя мониторит:

- Prometheus собирает свои метрики
- Grafana имеет встроенные дашборды для Prometheus
- Loki собирает логи Promtail

## Резервное копирование

### Важные данные

- Prometheus: PersistentVolume с метриками
- Grafana: PersistentVolume с дашбордами и настройками
- Loki: PersistentVolume с логами

### Рекомендации

- Регулярно делайте бэкап PersistentVolumes
- Экспортируйте дашборды Grafana в JSON
- Настройте retention политики для управления размером данных
